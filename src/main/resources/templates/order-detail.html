<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/base}">
<head>
    <title th:text="${pageTitle}">Chi tiết đơn hàng - Cửa hàng đồ Tết</title>
    <link rel="stylesheet" th:href="@{/css/order-detail.css?v=1}">
</head>
<body>
<div layout:fragment="content">
    <div class="order-detail-container">
        <div class="container">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" th:if="${breadcrumbItems}">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Trang chủ</a></li>
                    <li class="breadcrumb-item" th:each="item : ${breadcrumbItems}">
                        <a th:if="${item.url}" th:href="${item.url}" th:text="${item.name}">Link</a>
                        <span th:unless="${item.url}" th:text="${item.name}">Current</span>
                    </li>
                </ol>
            </nav>

            <!-- TODO THÀNH VIÊN 3 & 4: Load thông tin đơn hàng -->
            <div class="detail-card">
                <div class="order-header">
                    <div>
                        <h1 class="order-code">
                            <i class="fas fa-receipt"></i>
                            Đơn hàng <span
                                th:text="${donHang != null ? '#DH' + donHang.maDH : '#DH00000'}">#DH12345</span>
                        </h1>
                        <p class="text-muted mb-0">
                            <i class="far fa-calendar"></i>
                            Đặt ngày: <span
                                th:text="${donHang != null ? #temporals.format(donHang.ngayDat, 'dd/MM/yyyy HH:mm') : ''}">13/10/2025 14:30</span>
                        </p>
                    </div>
                    <div>
                        <!-- TODO THÀNH VIÊN 4: Hiển thị trạng thái động -->
                        <span class="status-badge"
                              th:classappend="${donHang != null ?
                                  (donHang.trangThaiDonHang.tenTTDH.contains('Chờ') ? 'status-pending' :
                                   donHang.trangThaiDonHang.tenTTDH.contains('Đã xác nhận') ? 'status-confirmed' :
                                   donHang.trangThaiDonHang.tenTTDH.contains('Đang giao') ? 'status-shipping' :
                                   donHang.trangThaiDonHang.tenTTDH.contains('Hoàn thành') ? 'status-delivered' :
                                   'status-cancelled') : 'status-pending'}"
                              th:text="${donHang != null ? donHang.trangThaiDonHang.tenTTDH : 'Chờ xác nhận'}">
                            Chờ xác nhận
                        </span>
                    </div>
                </div>

                <!-- Thông tin đơn hàng -->
                <div class="section-title">
                    <i class="fas fa-info-circle"></i>
                    <span>Thông tin đơn hàng</span>
                </div>

                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label"><i class="fas fa-user"></i> Người nhận</div>
                        <div class="info-value" th:text="${donHang != null ? donHang.khachHang.hoTen : 'Nguyễn Văn A'}">
                            Nguyễn Văn A
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label"><i class="fas fa-phone"></i> Số điện thoại</div>
                        <div class="info-value"
                             th:text="${donHang != null ? donHang.khachHang.soDienThoai : '0909123456'}">0909123456
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label"><i class="fas fa-map-marker-alt"></i> Địa chỉ giao hàng</div>
                        <div class="info-value"
                             th:text="${donHang != null ? donHang.diaChi.diaChiChiTiet : '123 Nguyễn Văn Linh, Q7, TP.HCM'}">
                            123 Nguyễn Văn Linh, Q7, TP.HCM
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label"><i class="fas fa-credit-card"></i> Phương thức thanh toán</div>
                        <div class="info-value"
                             th:text="${donHang != null ? donHang.phuongThucThanhToan.tenPTTT : 'COD'}">
                            Thanh toán khi nhận hàng (COD)
                        </div>
                    </div>
                </div>

                <!-- Ghi chú (nếu có) -->
                <div th:if="${donHang != null and donHang.ghiChu != null and !donHang.ghiChu.isEmpty()}"
                     class="note-section">
                    <strong><i class="fas fa-sticky-note"></i> Ghi chú:</strong>
                    <p class="mb-0 mt-2" th:text="${donHang.ghiChu}">Ghi chú của khách hàng</p>
                </div>
            </div>

            <!-- Chi tiết sản phẩm -->
            <div class="detail-card">
                <div class="section-title">
                    <i class="fas fa-box-open"></i>
                    <span>Chi tiết sản phẩm</span>
                </div>

                <table class="product-table">
                    <thead>
                    <tr>
                        <th>Sản phẩm</th>
                        <th>Đơn giá</th>
                        <th>Số lượng</th>
                        <th>Thành tiền</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- TODO THÀNH VIÊN 4: Load chi tiết đơn hàng -->
                    <tr th:if="${chiTietDonHang != null and !chiTietDonHang.isEmpty()}"
                        th:each="item : ${chiTietDonHang}">
                        <td>
                            <div class="d-flex align-items-center">
                                <img th:src="${item.sanPham.hinhAnh}" th:alt="${item.sanPham.tenSP}"
                                     class="product-img-table me-3" onerror="this.src='https://via.placeholder.com/80'">
                                <div>
                                    <div class="fw-bold" th:text="${item.sanPham.tenSP}">Giỏ quà Tết An Khang</div>
                                    <small class="text-muted">Mã SP: <span
                                            th:text="${item.sanPham.maSP}">SP001</span></small>
                                </div>
                            </div>
                        </td>
                        <td class="fw-bold"
                            th:text="${#numbers.formatDecimal(item.donGia, 0, 'COMMA', 0, 'POINT')} + ' đ'">500.000 đ
                        </td>
                        <td><span class="badge bg-secondary" th:text="${item.soLuong}">2</span></td>
                        <td class="fw-bold text-danger"
                            th:text="${#numbers.formatDecimal(item.donGia * item.soLuong, 0, 'COMMA', 0, 'POINT')} + ' đ'">
                            1.000.000 đ
                        </td>
                    </tr>

                    <!-- Placeholder -->
                    <tr th:if="${chiTietDonHang == null or chiTietDonHang.isEmpty()}">
                        <td>
                            <div class="d-flex align-items-center">
                                <img src="https://via.placeholder.com/80" class="product-img-table me-3">
                                <div>
                                    <div class="fw-bold">Giỏ quà Tết An Khang</div>
                                    <small class="text-muted">Mã SP: SP001</small>
                                </div>
                            </div>
                        </td>
                        <td class="fw-bold">500.000 đ</td>
                        <td><span class="badge bg-secondary">2</span></td>
                        <td class="fw-bold text-danger">1.000.000 đ</td>
                    </tr>
                    </tbody>
                </table>

                <!-- Tổng tiền -->
                <div class="summary-box">
                    <div class="summary-row">
                        <span>Tạm tính:</span>
                        <span th:text="${donHang != null ? #numbers.formatDecimal(donHang.tongTien, 0, 'COMMA', 0, 'POINT') + ' đ' : '1.500.000 đ'}">1.500.000 đ</span>
                    </div>
                    <div class="summary-row">
                        <span>Phí vận chuyển:</span>
                        <span class="text-success">Miễn phí</span>
                    </div>
                    <div class="summary-row summary-total">
                        <span>Tổng cộng:</span>
                        <span th:text="${donHang != null ? #numbers.formatDecimal(donHang.tongTien, 0, 'COMMA', 0, 'POINT') + ' đ' : '1.500.000 đ'}">1.500.000 đ</span>
                    </div>
                </div>
            </div>

            <!-- Trạng thái vận chuyển -->
            <div class="detail-card">
                <div class="section-title">
                    <i class="fas fa-shipping-fast"></i>
                    <span>Trạng thái vận chuyển</span>
                </div>

                <div class="timeline-vertical">
                    <!-- TODO THÀNH VIÊN 4: Tùy chỉnh timeline theo trạng thái thực tế -->
                    <div class="timeline-step active">
                        <div class="timeline-content">
                            <strong>Đơn hàng đã được đặt</strong>
                            <div class="small text-muted">13/10/2025 14:30</div>
                        </div>
                    </div>

                    <div class="timeline-step current">
                        <div class="timeline-content">
                            <strong>Chờ xác nhận</strong>
                            <div class="small text-muted">Đơn hàng đang được xử lý</div>
                        </div>
                    </div>

                    <div class="timeline-step">
                        <div class="timeline-content">
                            <strong>Đang chuẩn bị hàng</strong>
                            <div class="small text-muted">Chưa cập nhật</div>
                        </div>
                    </div>

                    <div class="timeline-step">
                        <div class="timeline-content">
                            <strong>Đang giao hàng</strong>
                            <div class="small text-muted">Chưa cập nhật</div>
                        </div>
                    </div>

                    <div class="timeline-step">
                        <div class="timeline-content">
                            <strong>Giao hàng thành công</strong>
                            <div class="small text-muted">Chưa cập nhật</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hành động -->
            <div class="detail-card">
                <div class="action-buttons">
                    <!-- TODO THÀNH VIÊN 4: Chỉ hiển thị nút hủy khi trạng thái cho phép -->
                    <button type="button" class="btn-cancel" onclick="confirmCancelOrder()"
                            th:if="${donHang != null and donHang.trangThaiDonHang.tenTTDH.contains('Chờ')}">
                        <i class="fas fa-times-circle"></i> Hủy đơn hàng
                    </button>

                    <button type="button" class="btn-reorder" onclick="reorder()">
                        <i class="fas fa-redo"></i> Đặt lại đơn hàng này
                    </button>

                    <a href="/profile" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Quay lại đơn hàng
                    </a>

                    <a href="/lienhe" class="btn btn-outline-primary">
                        <i class="fas fa-headset"></i> Liên hệ hỗ trợ
                    </a>
                </div>

                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle"></i>
                    <strong>Chính sách hủy đơn:</strong> Bạn chỉ có thể hủy đơn hàng khi trạng thái là "Chờ xác nhận".
                    Sau khi đơn hàng được xác nhận, vui lòng liên hệ hotline để được hỗ trợ.
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
    <script>
        // TODO THÀNH VIÊN 4: Xử lý hủy đơn hàng
        function confirmCancelOrder() {
            if (confirm('Bạn có chắc chắn muốn hủy đơn hàng này?\n\nLưu ý: Hành động này không thể hoàn tác.')) {
                const orderId = /*[[${donHang?.maDH}]]*/ 0;

                fetch(`/profile/orders/${orderId}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Đơn hàng đã được hủy thành công!');
                            location.reload();
                        } else {
                            alert('Lỗi: ' + (data.message || 'Không thể hủy đơn hàng'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Có lỗi xảy ra, vui lòng thử lại sau!');
                    });
            }
        }

        // TODO THÀNH VIÊN 3: Đặt lại đơn hàng (thêm vào giỏ hàng)
        function reorder() {
            if (confirm('Bạn muốn thêm tất cả sản phẩm trong đơn hàng này vào giỏ hàng?')) {
                // Logic thêm các sản phẩm vào giỏ hàng
                alert('Chức năng đang phát triển!');
            }
        }

        // In đơn hàng
        function printOrder() {
            window.print();
        }
    </script>
</th:block>
</body>
</html>
