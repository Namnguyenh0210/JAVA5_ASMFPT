<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{fragments/layout :: head('Gi·ªè H√†ng')}"></th:block>
    <link rel="stylesheet" th:href="@{/css/giohang.css}">
</head>
<body>
<!-- Header -->
<th:block th:replace="~{fragments/layout :: header}"></th:block>

<!-- Cart Header -->
<div class="cart-header-section">
    <div class="container">
        <h1 class="cart-title">
            <span class="icon">üõí</span>
            Gi·ªè H√†ng C·ªßa B·∫°n
        </h1>
        <div class="cart-progress">
            <div class="progress-step active">
                <div class="step-icon">1</div>
                <span>Gi·ªè H√†ng</span>
            </div>
            <div class="progress-line"></div>
            <div class="progress-step">
                <div class="step-icon">2</div>
                <span>Thanh To√°n</span>
            </div>
            <div class="progress-line"></div>
            <div class="progress-step">
                <div class="step-icon">3</div>
                <span>Ho√†n T·∫•t</span>
            </div>
        </div>
    </div>
</div>

<!-- Cart Section -->
<section class="cart-section">
    <div class="container">
        <div class="cart-content">
            <!-- Cart Items -->
            <div class="cart-items">
                <div class="cart-table">
                    <!-- Hi·ªÉn th·ªã khi gi·ªè h√†ng r·ªóng -->
                    <div th:if="${gioHangItems.isEmpty()}" class="empty-cart-notice">
                        <div class="empty-icon">üõí</div>
                        <h3>B·∫°n ch∆∞a th√™m s·∫£n ph·∫©m n√†o v√†o gi·ªè h√†ng!</h3>
                        <p>H√£y kh√°m ph√° c√°c s·∫£n ph·∫©m tuy·ªát v·ªùi c·ªßa ch√∫ng t√¥i</p>
                        <a th:href="@{/sanpham}" class="btn btn-primary">
                            <i class="fas fa-shopping-bag"></i>
                            Ti·∫øp T·ª•c Mua S·∫Øm
                        </a>
                    </div>

                    <!-- Hi·ªÉn th·ªã khi c√≥ s·∫£n ph·∫©m -->
                    <div th:unless="${gioHangItems.isEmpty()}">
                        <div class="table-header">
                            <div class="header-checkbox"></div>
                            <div class="header-item header-product">S·∫£n Ph·∫©m</div>
                            <div class="header-item header-center">ƒê∆°n Gi√°</div>
                            <div class="header-item header-center">S·ªë L∆∞·ª£ng</div>
                            <div class="header-item header-center">Th√†nh Ti·ªÅn</div>
                        </div>

                        <!-- Danh s√°ch s·∫£n ph·∫©m -->
                        <div th:each="item : ${gioHangItems}" class="cart-item" th:id="'item-' + ${item.sanPham.maSP}">
                            <div class="item-checkbox">
                                <input type="checkbox" class="item-select" th:data-id="${item.sanPham.maSP}"
                                       th:data-price="${item.sanPham.gia}"
                                       th:data-quantity="${item.soLuong}"
                                       onchange="updateSummary()">
                            </div>
                            <div class="item-product">
                                <div class="product-image">
                                    <img th:src="${item.sanPham.hinhAnh != null && !item.sanPham.hinhAnh.isEmpty() ? item.sanPham.hinhAnh : 'https://picsum.photos/200/200?random=' + item.sanPham.maSP}"
                                         th:alt="${item.sanPham.tenSP}">
                                </div>
                                <div class="product-info">
                                    <h3 th:text="${item.sanPham.tenSP}">T√™n s·∫£n ph·∫©m</h3>
                                    <div class="product-category">
                                        <i class="fas fa-tag"></i>
                                        <span th:text="${item.sanPham.loaiSanPham.tenLoai}">Danh m·ª•c</span>
                                    </div>
                                    <div class="product-attributes">
                                        <span class="attribute" th:if="${item.sanPham.soLuong != null}">
                                            <i class="fas fa-box"></i> C√≤n l·∫°i: <span th:text="${item.sanPham.soLuong}">0</span>
                                        </span>
                                        <span class="attribute" th:if="${item.sanPham.maSP != null}">
                                            <i class="fas fa-barcode"></i> M√£: <span th:text="${item.sanPham.maSP}">0</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="item-price">
                                <span class="current-price" th:text="${#numbers.formatDecimal(item.sanPham.gia, 0, 'COMMA', 0, 'POINT')} + 'ƒë'">0ƒë</span>
                            </div>
                            <div class="item-quantity">
                                <div class="quantity-controls">
                                    <button class="quantity-btn" th:onclick="'updateQuantity(' + ${item.sanPham.maSP} + ', -1)'">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="number" class="quantity-input" th:value="${item.soLuong}" min="1" max="99" readonly>
                                    <button class="quantity-btn" th:onclick="'updateQuantity(' + ${item.sanPham.maSP} + ', 1)'">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="item-total">
                                <span class="total-price" th:text="${#numbers.formatDecimal(item.sanPham.gia * item.soLuong, 0, 'COMMA', 0, 'POINT')} + 'ƒë'">0ƒë</span>
                            </div>
                            <div class="item-action" style="display: none;">
                                <button class="action-btn remove-item" th:onclick="'removeItem(' + ${item.sanPham.maSP} + ')'" title="X√≥a s·∫£n ph·∫©m">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Cart Actions - Di chuy·ªÉn xu·ªëng D∆Ø·ªöI C√ôNG -->
                        <div class="cart-actions">
                            <div class="left-actions">
                                <button class="btn btn-all" id="btnAll" onclick="toggleSelectAll()">
                                    <i class="fas fa-check-square"></i>
                                    All
                                </button>
                                <button class="btn btn-edit" id="btnEdit" onclick="toggleEditMode()">
                                    <i class="fas fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                            <div class="right-actions">
                                <a class="btn btn-secondary" th:href="@{/sanpham}">
                                    <i class="fas fa-arrow-left"></i>
                                    Ti·∫øp T·ª•c Mua S·∫Øm
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- X√≥a cart-actions c≈© ·ªü ƒë√¢y - kh√¥ng c·∫ßn n·ªØa -->
            </div>

            <!-- Cart Summary -->
            <div class="cart-summary">
                <div class="summary-card">
                    <h3 class="summary-title">T√≥m T·∫Øt ƒê∆°n H√†ng</h3>
                    <div class="summary-content">
                        <div class="summary-row">
                            <span>T·∫°m t√≠nh (<span id="selectedCount">0</span> s·∫£n ph·∫©m):</span>
                            <span id="subtotalAmount">0ƒë</span>
                        </div>

                        <div class="summary-row">
                            <span>Gi·∫£m gi√°:</span>
                            <span class="discount" id="discountAmount">0ƒë</span>
                        </div>

                        <div class="summary-row">
                            <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                            <span class="shipping-fee">
                                <span class="free-shipping" id="shippingFee">MI·ªÑN PH√ç</span>
                            </span>
                        </div>

                        <div class="summary-row total-row">
                            <span>T·ªïng c·ªông:</span>
                            <span class="total-amount" id="totalAmount">0ƒë</span>
                        </div>

                        <!-- Voucher -->
                        <div class="voucher-section">
                            <h4>M√£ Gi·∫£m Gi√°</h4>
                            <div class="voucher-input">
                                <input class="voucher-code" id="voucherCodeInput" placeholder="Nh·∫≠p m√£ gi·∫£m gi√°..." type="text">
                                <button class="voucher-apply-btn" onclick="applyVoucher()">√Åp D·ª•ng</button>
                            </div>
                            <div class="available-vouchers">
                                <div class="voucher-item">
                                    <div class="voucher-info">
                                        <div class="voucher-code-text">NEWYEAR2025</div>
                                        <div class="voucher-desc">Gi·∫£m 10% ƒë∆°n h√†ng t·ª´ 1 tri·ªáu</div>
                                    </div>
                                    <button class="voucher-select" onclick="selectVoucher('NEWYEAR2025')">Ch·ªçn</button>
                                </div>
                                <div class="voucher-item">
                                    <div class="voucher-info">
                                        <div class="voucher-code-text">FREESHIP</div>
                                        <div class="voucher-desc">Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn &lt;5km</div>
                                    </div>
                                    <button class="voucher-select" onclick="selectVoucher('FREESHIP')">Ch·ªçn</button>
                                </div>
                            </div>
                        </div>

                        <!-- Checkout Button -->
                        <button class="checkout-btn" onclick="checkout()" id="checkoutBtn" disabled>
                            <i class="fas fa-credit-card"></i>
                            Ti·∫øn H√†nh Thanh To√°n
                        </button>

                        <!-- Security Info -->
                        <div class="security-info">
                            <div class="security-item">
                                <i class="fas fa-shield-alt"></i>
                                <span>B·∫£o m·∫≠t thanh to√°n 100%</span>
                            </div>
                            <div class="security-item">
                                <i class="fas fa-undo"></i>
                                <span>ƒê·ªïi tr·∫£ trong 7 ng√†y</span>
                            </div>
                            <div class="security-item">
                                <i class="fas fa-shipping-fast"></i>
                                <span>Giao h√†ng nhanh 24h</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Footer -->
<th:block th:replace="~{fragments/layout :: footer}"></th:block>

<!-- Scripts -->
<script th:inline="javascript">
    let editMode = false;
    let appliedVoucher = null;

    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng s·∫£n ph·∫©m
    function updateQuantity(sanPhamId, change) {
        const item = document.getElementById(`item-${sanPhamId}`);
        const quantityInput = item.querySelector('.quantity-input');
        const currentQuantity = parseInt(quantityInput.value);
        const newQuantity = Math.max(1, currentQuantity + change);

        // G·ªçi API c·∫≠p nh·∫≠t
        fetch('/api/giohang/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `sanPhamId=${sanPhamId}&soLuong=${newQuantity}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                quantityInput.value = newQuantity;

                // Update checkbox data
                const checkbox = item.querySelector('.item-select');
                checkbox.dataset.quantity = newQuantity;

                // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn c·ªßa item
                const price = parseFloat(item.querySelector('.current-price').textContent.replace(/[^\d]/g, ''));
                const total = price * newQuantity;
                item.querySelector('.total-price').textContent = formatPrice(total);

                // Update summary if item is selected
                if (checkbox.checked) {
                    updateSummary();
                }
            } else {
                alert(data.message || 'C√≥ l·ªói x·∫£y ra!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t!');
        });
    }

    // X√≥a s·∫£n ph·∫©m
    function removeItem(sanPhamId) {
        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m n√†y kh·ªèi gi·ªè h√†ng?')) {
            fetch(`/api/giohang/remove/${sanPhamId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || 'C√≥ l·ªói x·∫£y ra!');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra khi x√≥a!');
            });
        }
    }

    // Ch·ªçn t·∫•t c·∫£
    function toggleSelectAll() {
        const checkboxes = document.querySelectorAll('.item-select');

        if (checkboxes.length === 0) return;

        // Check if all are currently checked
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);

        // Toggle: if all checked, uncheck all; otherwise check all
        checkboxes.forEach(checkbox => {
            checkbox.checked = !allChecked;
        });

        // Update button text
        const btnAll = document.getElementById('btnAll');
        if (!allChecked) {
            btnAll.innerHTML = '<i class="fas fa-check-square"></i> Unselect All';
        } else {
            btnAll.innerHTML = '<i class="fas fa-check-square"></i> All';
        }

        updateSummary();
    }

    // Ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
    function toggleEditMode() {
        editMode = !editMode;
        const actionColumns = document.querySelectorAll('.item-action');

        actionColumns.forEach(col => {
            col.style.display = editMode ? 'flex' : 'none';
        });

        const btnEdit = document.getElementById('btnEdit');
        btnEdit.innerHTML = editMode
            ? '<i class="fas fa-times"></i> Cancel'
            : '<i class="fas fa-edit"></i> Edit';
        btnEdit.classList.toggle('active', editMode);
    }

    // X√≥a c√°c s·∫£n ph·∫©m ƒë√£ ch·ªçn (ch·ªâ trong edit mode)
    function deleteSelected() {
        const selected = document.querySelectorAll('.item-select:checked');

        if (selected.length === 0) {
            alert('Vui l√≤ng ch·ªçn s·∫£n ph·∫©m c·∫ßn x√≥a!');
            return;
        }

        if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ${selected.length} s·∫£n ph·∫©m ƒë√£ ch·ªçn?`)) {
            const deletePromises = Array.from(selected).map(checkbox => {
                const sanPhamId = checkbox.dataset.id;
                return fetch(`/api/giohang/remove/${sanPhamId}`, { method: 'DELETE' });
            });

            Promise.all(deletePromises)
                .then(() => location.reload())
                .catch(error => {
                    console.error('Error:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi x√≥a!');
                });
        }
    }

    // Update summary based on selected items
    function updateSummary() {
        const selectedCheckboxes = document.querySelectorAll('.item-select:checked');
        let subtotal = 0;
        let count = 0;

        selectedCheckboxes.forEach(checkbox => {
            const price = parseFloat(checkbox.dataset.price);
            const quantity = parseInt(checkbox.dataset.quantity);
            subtotal += price * quantity;
            count++;
        });

        // Update count and subtotal
        document.getElementById('selectedCount').textContent = count;
        document.getElementById('subtotalAmount').textContent = count > 0 ? formatPrice(subtotal) : '0ƒë';

        // Calculate discount
        let discount = 0;
        if (appliedVoucher && count > 0 && subtotal > 0) {
            if (appliedVoucher === 'NEWYEAR2025' && subtotal >= 1000000) {
                discount = subtotal * 0.1;
            }
        }
        document.getElementById('discountAmount').textContent = discount > 0 ? '-' + formatPrice(discount) : '0ƒë';

        // Shipping fee - always 30,000ƒë when items are selected, unless FREESHIP voucher applied
        let shippingFee = 0;
        if (count > 0) {
            // Check if FREESHIP voucher is applied
            if (appliedVoucher === 'FREESHIP') {
                shippingFee = 0;
            } else {
                shippingFee = 30000;
            }
        }

        document.getElementById('shippingFee').textContent = count === 0 ? 'MI·ªÑN PH√ç' : (shippingFee === 0 ? 'MI·ªÑN PH√ç' : formatPrice(shippingFee));

        // Calculate total (subtotal - discount + shipping)
        const total = subtotal - discount + shippingFee;
        document.getElementById('totalAmount').textContent = count > 0 ? formatPrice(total) : '0ƒë';

        // Enable/disable checkout button
        const checkoutBtn = document.getElementById('checkoutBtn');
        checkoutBtn.disabled = count === 0;
    }

    // √Åp d·ª•ng voucher
    function selectVoucher(code) {
        document.getElementById('voucherCodeInput').value = code;
        applyVoucher();
    }

    function applyVoucher() {
        const code = document.getElementById('voucherCodeInput').value.trim();
        const selectedCount = document.querySelectorAll('.item-select:checked').length;

        if (selectedCount === 0) {
            alert('Vui l√≤ng ch·ªçn s·∫£n ph·∫©m tr∆∞·ªõc khi √°p d·ª•ng voucher!');
            return;
        }

        if (!code) {
            alert('Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°!');
            return;
        }

        appliedVoucher = code;
        updateSummary();
        alert(`√Åp d·ª•ng m√£ gi·∫£m gi√° "${code}" th√†nh c√¥ng!`);
    }

    // Thanh to√°n
    function checkout() {
        const selected = document.querySelectorAll('.item-select:checked');
        if (selected.length === 0) {
            alert('Vui l√≤ng ch·ªçn s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n!');
            return;
        }
        window.location.href = '/checkout';
    }

    // Format gi√° ti·ªÅn
    function formatPrice(price) {
        return new Intl.NumberFormat('vi-VN').format(price) + 'ƒë';
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => {
        updateSummary();
    });
</script>
</body>
</html>
