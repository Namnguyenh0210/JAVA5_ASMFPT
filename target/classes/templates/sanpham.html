<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{fragments/layout :: head('S·∫£n Ph·∫©m')}"></th:block>
    <link rel="stylesheet" th:href="@{/css/sanpham.css}">
</head>
<body>
<!-- Header -->
<th:block th:replace="~{fragments/layout :: header}"></th:block>

<!-- Breadcrumb -->
<th:block th:replace="~{fragments/layout :: breadcrumb(${[{name:'S·∫£n Ph·∫©m'}]})}"></th:block>

<!-- Page Header -->
<section class="page-header">
    <div class="container">
        <div class="header-content">
            <div class="header-text">
                <h1>üéä S·∫£n Ph·∫©m T·∫øt <span th:text="${tetYear != null ? tetYear : 2025}">2025</span></h1>
                <p>Kh√°m ph√° b·ªô s∆∞u t·∫≠p qu√† T·∫øt ƒë·∫∑c bi·ªát v·ªõi h√†ng trƒÉm s·∫£n ph·∫©m ch·∫•t l∆∞·ª£ng</p>
            </div>
            <div class="header-stats">
                <div class="stat-item">
                    <span class="stat-number" th:text="${sanPhamPage != null ? sanPhamPage.totalElements : 0}">0</span>
                    <span class="stat-label">S·∫£n Ph·∫©m</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" th:text="${categories != null ? #lists.size(categories) : 0}">0</span>
                    <span class="stat-label">Danh M·ª•c</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">100%</span>
                    <span class="stat-label">Ch·∫•t L∆∞·ª£ng</span>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Products Section -->
<section class="products-section">
    <div class="container">
        <div class="products-layout">
            <!-- Sidebar Filters -->
            <aside class="products-sidebar">
                <form id="filterForm" method="get" action="/sanpham">
                    <input type="hidden" name="page" value="0">
                    <input type="hidden" name="size" value="6">

                    <div class="filter-section">
                        <h3 class="filter-title">
                            <i class="fas fa-search"></i>
                            T√¨m Ki·∫øm
                        </h3>
                        <div class="search-wrapper">
                            <input class="search-input" name="search" placeholder="T√¨m s·∫£n ph·∫©m..."
                                   type="text" th:value="${search}">
                            <button class="search-btn" type="submit">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <div class="filter-section">
                        <h3 class="filter-title">
                            <i class="fas fa-list"></i>
                            Danh M·ª•c
                        </h3>
                        <div class="filter-options">
                            <label class="filter-option">
                                <input th:checked="${loai == null}" name="loai" type="radio" value=""
                                       onchange="document.getElementById('filterForm').submit()">
                                <span class="checkmark-circle"></span>
                                <span class="option-text">T·∫•t C·∫£</span>
                            </label>
                            <th:block th:if="${categories != null and #lists.size(categories) > 0}">
                                <label class="filter-option" th:each="cat : ${categories}">
                                    <input th:checked="${loai != null and loai == cat.maLoai}"
                                           name="loai" type="radio" th:value="${cat.maLoai}"
                                           onchange="document.getElementById('filterForm').submit()">
                                    <span class="checkmark-circle"></span>
                                    <span class="option-text" th:text="${cat.tenLoai}">Danh m·ª•c</span>
                                </label>
                            </th:block>
                            <th:block th:if="${categories == null or #lists.size(categories) == 0}">
                                <div class="no-categories">Kh√¥ng c√≥ danh m·ª•c n√†o.</div>
                            </th:block>
                        </div>
                    </div>

                    <!-- Price Filter Section -->
                    <div class="filter-section">
                        <h3 class="filter-title">
                            <i class="fas fa-dollar-sign"></i>
                            Kho·∫£ng Gi√° (x1000 VNƒê)
                        </h3>
                        <div class="price-range">
                            <div class="price-input-group">
                                <label class="price-label">T·ª´</label>
                                <input class="price-input" id="priceMin" name="minPrice"
                                       type="number" th:value="${minPrice != null ? minPrice / 1000 : 0}"
                                       min="0" step="100" placeholder="0">
                            </div>
                            <div class="price-input-group">
                                <label class="price-label">ƒê·∫øn</label>
                                <input class="price-input" id="priceMax" name="maxPrice"
                                       type="number" th:value="${maxPrice != null ? maxPrice / 1000 : 100}"
                                       min="0" step="100" placeholder="100">
                            </div>
                            <button class="price-apply-btn" type="submit" onclick="convertPriceToVND()">√Åp D·ª•ng</button>
                        </div>
                    </div>

                    <button class="clear-filters-btn" type="button" onclick="clearFilters()">
                        <i class="fas fa-times"></i>
                        X√≥a B·ªô L·ªçc
                    </button>
                </form>
            </aside>

            <!-- Main Content -->
            <main class="products-main">
                <!-- Toolbar -->
                <div class="products-toolbar">
                    <div class="toolbar-info">
                        <span class="results-count" th:if="${sanPhamPage != null and sanPhamPage.totalElements > 0}">
                            Hi·ªÉn th·ªã
                            <span th:text="${sanPhamPage.number * sanPhamPage.size + 1}">1</span>-<span th:text="${sanPhamPage.number * sanPhamPage.size + sanPhamPage.numberOfElements}">6</span>
                            c·ªßa <span th:text="${sanPhamPage.totalElements}">0</span> s·∫£n ph·∫©m
                        </span>
                        <span class="results-count" th:if="${sanPhamPage == null or sanPhamPage.totalElements == 0}">
                            Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o
                        </span>
                    </div>
                    <div class="toolbar-controls">
                        <div class="sort-dropdown">
                            <select class="sort-select" id="sortSelect" onchange="applySort()">
                                <option value="moi" th:selected="${sort == null or sort == 'moi'}">M·ªõi nh·∫•t</option>
                                <option value="gia-tang" th:selected="${sort == 'gia-tang'}">Gi√°: Th·∫•p ƒë·∫øn Cao</option>
                                <option value="gia-giam" th:selected="${sort == 'gia-giam'}">Gi√°: Cao ƒë·∫øn Th·∫•p</option>
                            </select>
                        </div>
                        <!-- Cart Icon with Count -->
                        <a href="/giohang" class="cart-icon-btn">
                            <i class="fas fa-shopping-cart"></i>
                            <span class="cart-count-badge" id="cartCountBadge">0</span>
                        </a>
                    </div>
                </div>

                <!-- Products Grid -->
                <div class="products-grid" id="productsGrid">
                    <th:block th:if="${sanPhamPage == null or sanPhamPage.totalElements == 0}">
                        <div class="no-products" style="grid-column: 1/-1; text-align: center; padding: 60px 20px;">
                            <i class="fas fa-box-open" style="font-size: 64px; color: #ddd; margin-bottom: 20px;"></i>
                            <h3>Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ph√π h·ª£p</h3>
                            <p>Vui l√≤ng th·ª≠ l·∫°i v·ªõi b·ªô l·ªçc kh√°c</p>
                        </div>
                    </th:block>
                    <th:block th:if="${sanPhamPage != null and sanPhamPage.totalElements > 0}">
                        <div class="product-card" th:each="sp : ${sanPhamPage.content}">
                            <a th:href="@{'/sanpham/' + ${sp.maSP}}" class="product-link">
                                <div class="product-image">
                                    <img th:src="${sp.hinhAnh}" th:alt="${sp.tenSP}"
                                         onerror="this.src='https://via.placeholder.com/300x300?text=No+Image'"/>
                                    <div class="product-badge" th:if="${sp.soLuong < 10 and sp.soLuong > 0}">
                                        <span class="badge badge-warning">S·∫Øp h·∫øt</span>
                                    </div>
                                    <div class="product-badge" th:if="${sp.soLuong == 0}">
                                        <span class="badge badge-danger">H·∫øt h√†ng</span>
                                    </div>
                                </div>
                                <div class="product-info">
                                    <div class="product-category" th:if="${sp.loaiSanPham != null}"
                                         th:text="${sp.loaiSanPham.tenLoai}">Danh m·ª•c</div>
                                    <h3 class="product-title" th:text="${sp.tenSP}">T√™n s·∫£n ph·∫©m</h3>
                                    <div class="product-price">
                                        <span class="price" th:text="${#numbers.formatDecimal(sp.gia, 0, 'COMMA', 0, 'POINT')} + ' ƒë'">0 ƒë</span>
                                    </div>
                                    <div class="product-stock" th:if="${sp.soLuong > 0}">
                                        <i class="fas fa-check-circle"></i> C√≤n h√†ng
                                    </div>
                                    <div class="product-stock out-of-stock" th:if="${sp.soLuong == 0}">
                                        <i class="fas fa-times-circle"></i> H·∫øt h√†ng
                                    </div>
                                </div>
                            </a>
                            <div class="product-actions">
                                <button th:if="${sp.soLuong > 0}"
                                        class="btn-add-to-cart"
                                        th:data-product-id="${sp.maSP}"
                                        th:data-product-name="${sp.tenSP}"
                                        onclick="addToCart(this); event.stopPropagation();">
                                    <i class="fas fa-shopping-cart"></i>
                                    <span class="btn-text">Th√™m V√†o Gi·ªè H√†ng</span>
                                    <span class="btn-success-text">‚úì ƒê√£ Th√™m V√†o Gi·ªè</span>
                                </button>
                                <button th:if="${sp.soLuong == 0}"
                                        class="btn-add-to-cart btn-disabled"
                                        disabled>
                                    <i class="fas fa-ban"></i>
                                    <span class="btn-text">H·∫øt H√†ng</span>
                                </button>
                            </div>
                        </div>
                    </th:block>
                </div>

                <!-- Pagination - Thi·∫øt k·∫ø m·ªõi ƒë·∫πp h∆°n -->
                <div class="pagination-wrapper" th:if="${sanPhamPage != null and sanPhamPage.totalPages > 1}">
                    <div class="pagination">
                        <!-- Previous Button -->
                        <a th:if="${sanPhamPage.hasPrevious()}"
                           th:href="@{/sanpham(page=${sanPhamPage.number - 1}, size=6, search=${search}, loai=${loai}, minPrice=${minPrice}, maxPrice=${maxPrice}, sort=${sort})}"
                           class="pagination-btn pagination-prev">
                            <i class="fas fa-chevron-left"></i>
                            <span>Tr∆∞·ªõc</span>
                        </a>
                        <span th:unless="${sanPhamPage.hasPrevious()}" class="pagination-btn pagination-prev disabled">
                            <i class="fas fa-chevron-left"></i>
                            <span>Tr∆∞·ªõc</span>
                        </span>

                        <!-- Page Numbers -->
                        <div class="pagination-numbers">
                            <!-- First page -->
                            <a th:if="${sanPhamPage.number > 2}"
                               th:href="@{/sanpham(page=0, size=6, search=${search}, loai=${loai}, minPrice=${minPrice}, maxPrice=${maxPrice}, sort=${sort})}"
                               class="pagination-number">1</a>

                            <!-- Dots before -->
                            <span th:if="${sanPhamPage.number > 3}" class="pagination-dots">...</span>

                            <!-- Current page range -->
                            <th:block th:each="i : ${#numbers.sequence(0, sanPhamPage.totalPages - 1)}">
                                <a th:if="${i >= sanPhamPage.number - 2 and i <= sanPhamPage.number + 2}"
                                   th:href="@{/sanpham(page=${i}, size=6, search=${search}, loai=${loai}, minPrice=${minPrice}, maxPrice=${maxPrice}, sort=${sort})}"
                                   th:classappend="${i == sanPhamPage.number} ? 'active' : ''"
                                   class="pagination-number"
                                   th:text="${i + 1}">1</a>
                            </th:block>

                            <!-- Dots after -->
                            <span th:if="${sanPhamPage.number < sanPhamPage.totalPages - 4}" class="pagination-dots">...</span>

                            <!-- Last page -->
                            <a th:if="${sanPhamPage.number < sanPhamPage.totalPages - 3}"
                               th:href="@{/sanpham(page=${sanPhamPage.totalPages - 1}, size=6, search=${search}, loai=${loai}, minPrice=${minPrice}, maxPrice=${maxPrice}, sort=${sort})}"
                               class="pagination-number"
                               th:text="${sanPhamPage.totalPages}">10</a>
                        </div>

                        <!-- Next Button -->
                        <a th:if="${sanPhamPage.hasNext()}"
                           th:href="@{/sanpham(page=${sanPhamPage.number + 1}, size=6, search=${search}, loai=${loai}, minPrice=${minPrice}, maxPrice=${maxPrice}, sort=${sort})}"
                           class="pagination-btn pagination-next">
                            <span>Sau</span>
                            <i class="fas fa-chevron-right"></i>
                        </a>
                        <span th:unless="${sanPhamPage.hasNext()}" class="pagination-btn pagination-next disabled">
                            <span>Sau</span>
                            <i class="fas fa-chevron-right"></i>
                        </span>
                    </div>

                    <!-- Page Info -->
                    <div class="pagination-info">
                        Trang <strong th:text="${sanPhamPage.number + 1}">1</strong> / <strong th:text="${sanPhamPage.totalPages}">10</strong>
                    </div>
                </div>
            </main>
        </div>
    </div>
</section>

<!-- Footer -->
<th:block th:replace="~{fragments/layout :: footer}"></th:block>

<!-- Scripts -->
<th:block th:replace="~{fragments/layout :: scripts}"></th:block>
<script>
    // Load cart count on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateCartCount();
    });

    // Update cart count from API
    function updateCartCount() {
        fetch('/api/giohang/count')
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('cartCountBadge');
                if (badge && data.count !== undefined) {
                    badge.textContent = data.count;
                    badge.style.display = data.count > 0 ? 'flex' : 'none';
                }
            })
            .catch(error => console.error('Error loading cart count:', error));
    }

    // Apply sort
    function applySort() {
        const sortValue = document.getElementById('sortSelect').value;
        const form = document.getElementById('filterForm');

        // Add sort parameter
        let sortInput = form.querySelector('input[name="sort"]');
        if (!sortInput) {
            sortInput = document.createElement('input');
            sortInput.type = 'hidden';
            sortInput.name = 'sort';
            form.appendChild(sortInput);
        }
        sortInput.value = sortValue;

        form.submit();
    }

    // Clear all filters
    function clearFilters() {
        window.location.href = '/sanpham?page=0&size=6';
    }

    // Auto-submit search on Enter
    document.querySelector('.search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('filterForm').submit();
        }
    });

    // Add to cart function with animation
    function addToCart(button) {
        const productId = button.dataset.productId;
        const productName = button.dataset.productName;

        // Disable button to prevent multiple clicks
        if (button.classList.contains('adding') || button.classList.contains('added')) {
            return;
        }

        button.classList.add('adding');
        button.disabled = true;

        // Call API to add to cart
        fetch('/api/giohang/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `sanPhamId=${productId}&soLuong=1`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Success animation
                button.classList.remove('adding');
                button.classList.add('added');

                // Update cart count with animation
                updateCartCount();

                // Add pulse animation to cart badge
                const badge = document.getElementById('cartCountBadge');
                if (badge) {
                    badge.classList.add('pulse');
                    setTimeout(() => badge.classList.remove('pulse'), 500);
                }

                // Show success notification
                showNotification(`‚úì ƒê√£ th√™m "${productName}" v√†o gi·ªè h√†ng!`, 'success');

                // Reset button after 2 seconds
                setTimeout(() => {
                    button.classList.remove('added');
                    button.disabled = false;
                }, 2000);
            } else {
                // Error handling
                button.classList.remove('adding');
                button.disabled = false;

                if (data.message) {
                    if (data.message.includes('ƒëƒÉng nh·∫≠p')) {
                        showNotification('‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng!', 'warning');
                        setTimeout(() => {
                            window.location.href = '/login?redirect=/sanpham';
                        }, 1500);
                    } else {
                        showNotification('‚ö†Ô∏è ' + data.message, 'warning');
                    }
                } else {
                    showNotification('‚ùå C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i!', 'error');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            button.classList.remove('adding');
            button.disabled = false;
            showNotification('‚ùå C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i!', 'error');
        });
    }

    // Show notification function
    function showNotification(message, type) {
        // Remove existing notification
        const existing = document.querySelector('.cart-notification');
        if (existing) {
            existing.remove();
        }

        // Create notification
        const notification = document.createElement('div');
        notification.className = `cart-notification ${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <span class="notification-message">${message}</span>
                <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        document.body.appendChild(notification);

        // Show notification
        setTimeout(() => notification.classList.add('show'), 100);

        // Auto hide after 3 seconds
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 400);
        }, 3000);
    }

    // Adjust price input value
    function adjustPrice(inputId, delta) {
        const input = document.getElementById(inputId);
        let newValue = parseInt(input.value) + delta;
        if (newValue < 0) newValue = 0;
        input.value = newValue;
    }

    // Convert price from thousands to VND before submit
    function convertPriceToVND() {
        const priceMin = document.getElementById('priceMin');
        const priceMax = document.getElementById('priceMax');

        // Convert from thousands to actual VND (multiply by 1000)
        priceMin.value = parseInt(priceMin.value) * 1000;
        priceMax.value = parseInt(priceMax.value) * 1000;

        return true; // Allow form submission
    }
</script>
</body>
</html>
