<!DOCTYPE html>
<html
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{layouts/admin-base}">
<head>
    <title>Thống kê - Admin Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div layout:fragment="content">
    <div class="page-title">
        <i class="fas fa-chart-bar"></i>
        <span>Thống kê chi tiết</span>
    </div>

    <!-- TODO: THÀNH VIÊN 4 - Bộ lọc thời gian -->
    <div class="card mb-4">
        <div class="card-body">
            <h5><i class="fas fa-filter"></i> Bộ lọc thống kê</h5>
            <form method="get" action="/admin/thongke" class="row g-3 mt-2">
                <div class="col-md-3">
                    <label class="form-label">Từ ngày:</label>
                    <input type="date" name="startDate" class="form-control"
                           th:value="${startDate}" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Đến ngày:</label>
                    <input type="date" name="endDate" class="form-control"
                           th:value="${endDate}" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Loại thống kê:</label>
                    <select name="type" class="form-select">
                        <option value="day" th:selected="${type == 'day'}">Theo ngày</option>
                        <option value="week" th:selected="${type == 'week'}">Theo tuần</option>
                        <option value="month" th:selected="${type == 'month'}">Theo tháng</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search"></i> Lọc dữ liệu
                    </button>
                </div>
            </form>
            <p class="text-muted mt-3 mb-0">
                <i class="fas fa-info-circle"></i>
                <strong>TODO TV4:</strong> Implement logic lọc theo khoảng thời gian trong AdminThongKeController
            </p>
        </div>
    </div>

    <!-- TODO: THÀNH VIÊN 4 - Các thẻ thống kê tổng quan -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-dollar-sign"></i> Tổng doanh thu
                    </h6>
                    <h3 class="mb-0"
                        th:text="${#numbers.formatDecimal(tongDoanhThu ?: 0, 0, 'COMMA', 0, 'POINT')} + ' đ'">0 đ</h3>
                    <small>TODO TV4: Query sum(TongTien) từ DonHang</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-shopping-cart"></i> Tổng đơn hàng
                    </h6>
                    <h3 class="mb-0" th:text="${tongDonHang ?: 0}">0</h3>
                    <small>TODO TV4: Count đơn hàng</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-box"></i> Đơn hàng mới
                    </h6>
                    <h3 class="mb-0" th:text="${donHangMoi ?: 0}">0</h3>
                    <small>TODO TV4: Đơn hôm nay</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-chart-line"></i> Doanh thu hôm nay
                    </h6>
                    <h3 class="mb-0"
                        th:text="${#numbers.formatDecimal(doanhThuHomNay ?: 0, 0, 'COMMA', 0, 'POINT')} + ' đ'">0 đ</h3>
                    <small>TODO TV4: Tổng tiền hôm nay</small>
                </div>
            </div>
        </div>
    </div>

    <!-- TODO: THÀNH VIÊN 4 - Biểu đồ doanh thu theo tháng -->
    <div class="card mb-4">
        <div class="card-body">
            <h5><i class="fas fa-chart-line"></i> Biểu đồ doanh thu 12 tháng gần nhất</h5>
            <canvas id="monthlyChart" height="80"></canvas>
            <p class="text-muted mt-3 mb-0">
                <strong>TODO TV4:</strong> Query doanh thu 12 tháng, truyền vào Chart.js bên dưới
            </p>
        </div>
    </div>

    <div class="row">
        <!-- TODO: THÀNH VIÊN 4 - Top sản phẩm bán chạy -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5><i class="fas fa-fire"></i> Top 10 sản phẩm bán chạy</h5>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                            <tr>
                                <th>Hạng</th>
                                <th>Tên sản phẩm</th>
                                <th>Đã bán</th>
                            </tr>
                            </thead>
                            <tbody>
                            <!-- TODO TV4: Loop topProducts
                            <tr th:each="sp, stat : ${topProducts}">
                                <td th:text="${stat.count}"></td>
                                <td th:text="${sp.tenSP}"></td>
                                <td th:text="${sp.soLuongBan}"></td>
                            </tr>
                            -->
                            <tr>
                                <td colspan="3" class="text-center text-muted py-3">
                                    <i class="fas fa-inbox"></i><br>
                                    TODO TV4: Query TOP 10 từ DonHangChiTiet
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TODO: THÀNH VIÊN 4 - Khách hàng mua nhiều nhất -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5><i class="fas fa-users"></i> Top 10 khách hàng VIP</h5>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                            <tr>
                                <th>Hạng</th>
                                <th>Họ tên</th>
                                <th>Tổng chi tiêu</th>
                            </tr>
                            </thead>
                            <tbody>
                            <!-- TODO TV4: Loop topCustomers
                            <tr th:each="kh, stat : ${topCustomers}">
                                <td th:text="${stat.count}"></td>
                                <td th:text="${kh.hoTen}"></td>
                                <td th:text="${#numbers.formatDecimal(kh.tongChiTieu, 0, 'COMMA', 0, 'POINT')} + ' đ'"></td>
                            </tr>
                            -->
                            <tr>
                                <td colspan="3" class="text-center text-muted py-3">
                                    <i class="fas fa-inbox"></i><br>
                                    TODO TV4: Query TOP 10 từ DonHang GROUP BY MaKH
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TODO: THÀNH VIÊN 4 - Bảng thống kê tổng hợp -->
    <div class="card">
        <div class="card-body">
            <h5><i class="fas fa-table"></i> Bảng thống kê chi tiết theo thời gian</h5>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                    <tr>
                        <th>Thời gian</th>
                        <th>Số đơn hàng</th>
                        <th>Doanh thu</th>
                        <th>Đơn thành công</th>
                        <th>Đơn hủy</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- TODO TV4: Loop detailReport
                    <tr th:each="row : ${detailReport}">
                        <td th:text="${row.thoiGian}"></td>
                        <td th:text="${row.soDonHang}"></td>
                        <td th:text="${#numbers.formatDecimal(row.doanhThu, 0, 'COMMA', 0, 'POINT')} + ' đ'"></td>
                        <td th:text="${row.donThanhCong}"></td>
                        <td th:text="${row.donHuy}"></td>
                    </tr>
                    -->
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                            TODO TV4: Thống kê theo ngày/tuần/tháng dựa vào tham số 'type'
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- TODO: THÀNH VIÊN 4 - Script Chart.js cho biểu đồ -->
<script layout:fragment="scripts">
    // TODO TV4: Truyền dữ liệu từ Thymeleaf vào JavaScript
    const monthlyData = {
        // VÍ DỤ: Nhận từ controller
        labels: [/*# th:if="${monthlyRevenue}" */
            /*[# th:each="entry : ${monthlyRevenue}" ]*/
            /*[[${entry.key}]],*/
            /*[/]*/
            /*#/*/
        ],
        data: [/*# th:if="${monthlyRevenue}" */
            /*[# th:each="entry : ${monthlyRevenue}" ]*/
            /*[[${entry.value}]],*/
            /*[/]*/
            /*#/*/
        ]
    };

    // Vẽ biểu đồ
    const ctx = document.getElementById('monthlyChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: monthlyData.labels.length > 0 ? monthlyData.labels :
                    ['01/2025', '02/2025', '03/2025', '04/2025', '05/2025', '06/2025',
                        '07/2025', '08/2025', '09/2025', '10/2025', '11/2025', '12/2025'],
                datasets: [{
                    label: 'Doanh thu (VNĐ)',
                    data: monthlyData.data.length > 0 ? monthlyData.data : [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return 'Doanh thu: ' + context.parsed.y.toLocaleString('vi-VN') + ' đ';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return value.toLocaleString('vi-VN') + ' đ';
                            }
                        }
                    }
                }
            }
        });
    }
</script>

</body>
</html>
