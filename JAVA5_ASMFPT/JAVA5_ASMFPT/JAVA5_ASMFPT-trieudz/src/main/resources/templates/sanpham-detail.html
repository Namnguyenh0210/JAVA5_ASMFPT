<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/base}">
<head>
    <title th:text="${pageTitle}">Chi tiết sản phẩm - Cửa hàng đồ Tết</title>
    <link rel="stylesheet" th:href="@{/css/sanpham-detail.css?v=1}">
</head>
<body>
<div layout:fragment="content">
    <div class="product-detail-container">
        <div class="container">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Trang chủ</a></li>
                    <li class="breadcrumb-item"><a href="/sanpham">Sản phẩm</a></li>
                    <li class="breadcrumb-item" th:if="${sanPham != null and sanPham.loaiSanPham != null}">
                        <a th:href="@{/sanpham(loai=${sanPham.loaiSanPham.maLoai})}"
                           th:text="${sanPham.loaiSanPham.tenLoai}">Giỏ quà Tết</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page"
                        th:text="${sanPham != null ? sanPham.tenSP : 'Chi tiết sản phẩm'}">Sản phẩm
                    </li>
                </ol>
            </nav>

            <!-- TODO THÀNH VIÊN 3: Load thông tin sản phẩm từ model -->
            <div class="row">
                <!-- Gallery -->
                <div class="col-lg-6">
                    <div class="product-gallery">
                        <img th:src="${sanPham != null ? sanPham.hinhAnh : 'https://via.placeholder.com/500'}"
                             th:alt="${sanPham != null ? sanPham.tenSP : 'Sản phẩm'}"
                             class="main-image" id="mainImage"
                             onerror="this.src='https://via.placeholder.com/500'">

                        <!-- TODO: Có thể thêm nhiều ảnh nếu có bảng HinhAnhSanPham -->
                        <div class="thumbnail-list">
                            <img th:src="${sanPham != null ? sanPham.hinhAnh : 'https://via.placeholder.com/80'}"
                                 class="thumbnail active" onclick="changeMainImage(this)">
                        </div>
                    </div>
                </div>

                <!-- Info -->
                <div class="col-lg-6">
                    <div class="product-info">
                        <h1 class="product-name" th:text="${sanPham != null ? sanPham.tenSP : 'Tên sản phẩm'}">
                            Giỏ quà Tết An Khang
                        </h1>

                        <!-- Rating -->
                        <div class="product-rating">
                            <div class="stars">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star-half-alt"></i>
                            </div>
                            <span class="rating-count">(4.5 - 128 đánh giá)</span>
                        </div>

                        <!-- Price -->
                        <div class="product-price"
                             th:text="${sanPham != null ? #numbers.formatDecimal(sanPham.gia, 0, 'COMMA', 0, 'POINT') + ' đ' : '0 đ'}">
                            500.000 đ
                        </div>

                        <!-- Stock Status -->
                        <div th:if="${sanPham != null}">
                            <span class="stock-status"
                                  th:classappend="${sanPham.soLuong > 10 ? 'stock-available' : (sanPham.soLuong > 0 ? 'stock-low' : 'stock-out')}">
                                <i class="fas"
                                   th:classappend="${sanPham.soLuong > 0 ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                                <span th:text="${sanPham.soLuong > 0 ? 'Còn hàng (' + sanPham.soLuong + ' sản phẩm)' : 'Hết hàng'}">Còn hàng</span>
                            </span>
                        </div>

                        <!-- Description Short -->
                        <div class="mt-3" th:if="${sanPham != null and sanPham.moTa != null}">
                            <p th:utext="${#strings.abbreviate(sanPham.moTa, 200)}">Mô tả ngắn về sản phẩm...</p>
                        </div>

                        <!-- Quantity Selector -->
                        <div class="quantity-selector">
                            <label class="fw-bold">Số lượng:</label>
                            <div class="quantity-input">
                                <button class="quantity-btn" onclick="decreaseQuantity()">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="number" id="quantity" class="quantity-value" value="1" min="1"
                                       th:max="${sanPham != null ? sanPham.soLuong : 999}">
                                <button class="quantity-btn" onclick="increaseQuantity()">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <button class="btn-add-cart" onclick="addToCart()"
                                th:disabled="${sanPham == null or sanPham.soLuong <= 0}">
                            <i class="fas fa-shopping-cart"></i> Thêm vào giỏ hàng
                        </button>
                        <button class="btn-buy-now" onclick="buyNow()"
                                th:disabled="${sanPham == null or sanPham.soLuong <= 0}">
                            <i class="fas fa-bolt"></i> Mua ngay
                        </button>

                        <!-- Product Meta -->
                        <div class="product-meta">
                            <div class="meta-item">
                                <i class="fas fa-tag"></i>
                                <span>Danh mục:
                                    <a th:if="${sanPham != null and sanPham.loaiSanPham != null}"
                                       th:href="@{/sanpham(loai=${sanPham.loaiSanPham.maLoai})}"
                                       th:text="${sanPham.loaiSanPham.tenLoai}">Giỏ quà Tết</a>
                                </span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-barcode"></i>
                                <span>Mã SP: <span
                                        th:text="${sanPham != null ? sanPham.maSP : 'N/A'}">SP001</span></span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-truck"></i>
                                <span>Miễn phí vận chuyển cho đơn hàng từ 300.000đ</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-shield-alt"></i>
                                <span>Đảm bảo chất lượng 100%</span>
                            </div>
                        </div>

                        <!-- Share Buttons -->
                        <div class="share-buttons">
                            <span class="fw-bold">Chia sẻ:</span>
                            <a href="#" class="share-btn"><i class="fab fa-facebook-f"></i></a>
                            <a href="#" class="share-btn"><i class="fab fa-twitter"></i></a>
                            <a href="#" class="share-btn"><i class="fab fa-pinterest-p"></i></a>
                            <a href="#" class="share-btn"><i class="fas fa-envelope"></i></a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs: Description, Reviews -->
            <div class="tabs-section">
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#description"
                                type="button">
                            <i class="fas fa-align-left"></i> Mô tả chi tiết
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#reviews" type="button">
                            <i class="fas fa-star"></i> Đánh giá (<span
                                th:text="${reviewCount != null ? reviewCount : 0}">0</span>)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#shipping" type="button">
                            <i class="fas fa-shipping-fast"></i> Chính sách vận chuyển
                        </button>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- Description Tab -->
                    <div class="tab-pane fade show active" id="description">
                        <div class="description-content" th:if="${sanPham != null and sanPham.moTa != null}"
                             th:utext="${sanPham.moTa}">
                            <p>Mô tả chi tiết về sản phẩm...</p>
                        </div>
                        <div th:if="${sanPham == null or sanPham.moTa == null}">
                            <p>Chưa có mô tả chi tiết cho sản phẩm này.</p>
                        </div>
                    </div>

                    <!-- Reviews Tab -->
                    <div class="tab-pane fade" id="reviews">
                        <!-- TODO THÀNH VIÊN 3: Load danh sách đánh giá từ bảng DanhGia -->
                        <div th:if="${danhGiaList != null and !danhGiaList.isEmpty()}">
                            <div th:each="dg : ${danhGiaList}" class="review-item">
                                <div class="review-header">
                                    <span class="reviewer-name" th:text="${dg.khachHang.hoTen}">Nguyễn Văn A</span>
                                    <span class="review-date" th:text="${#temporals.format(dg.ngayDG, 'dd/MM/yyyy')}">01/01/2025</span>
                                </div>
                                <div class="review-rating">
                                    <i th:each="i : ${#numbers.sequence(1, dg.soSao)}" class="fas fa-star"></i>
                                    <i th:each="i : ${#numbers.sequence(dg.soSao + 1, 5)}" class="far fa-star"></i>
                                </div>
                                <p th:text="${dg.binhLuan}">Sản phẩm rất tốt, chất lượng đúng như mô tả!</p>
                            </div>
                        </div>

                        <!-- Placeholder -->
                        <div th:if="${danhGiaList == null or danhGiaList.isEmpty()}">
                            <div class="text-center py-5">
                                <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Chưa có đánh giá nào cho sản phẩm này.</p>
                                <p class="text-muted">Hãy là người đầu tiên đánh giá!</p>
                            </div>
                        </div>
                    </div>

                    <!-- Shipping Tab -->
                    <div class="tab-pane fade" id="shipping">
                        <h5>Chính sách giao hàng</h5>
                        <ul>
                            <li>Miễn phí vận chuyển cho đơn hàng từ 300.000đ</li>
                            <li>Giao hàng trong vòng 2-3 ngày làm việc</li>
                            <li>Hỗ trợ đổi trả trong vòng 7 ngày nếu sản phẩm bị lỗi</li>
                            <li>Thanh toán khi nhận hàng (COD)</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Related Products -->
            <!-- TODO THÀNH VIÊN 3: Load sản phẩm liên quan -->
            <div class="related-products">
                <h2 class="section-title">
                    <i class="fas fa-box-open"></i> Sản phẩm liên quan
                </h2>

                <div class="row">
                    <div th:if="${relatedProducts != null and !relatedProducts.isEmpty()}"
                         th:each="sp : ${relatedProducts}" class="col-lg-3 col-md-4 col-sm-6 mb-4">
                        <a th:href="@{/sanpham/{id}(id=${sp.maSP})}" class="text-decoration-none">
                            <div class="product-card">
                                <img th:src="${sp.hinhAnh}" th:alt="${sp.tenSP}" class="product-card-img"
                                     onerror="this.src='https://via.placeholder.com/250'">
                                <div class="product-card-body">
                                    <h5 class="product-card-title" th:text="${sp.tenSP}">Tên sản phẩm</h5>
                                    <div class="product-card-price"
                                         th:text="${#numbers.formatDecimal(sp.gia, 0, 'COMMA', 0, 'POINT')} + ' đ'">
                                        500.000 đ
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>

                    <!-- Placeholder -->
                    <div th:if="${relatedProducts == null or relatedProducts.isEmpty()}"
                         th:each="i : ${#numbers.sequence(1, 4)}" class="col-lg-3 col-md-4 col-sm-6 mb-4">
                        <div class="product-card">
                            <img src="https://via.placeholder.com/250" class="product-card-img">
                            <div class="product-card-body">
                                <h5 class="product-card-title">Giỏ quà Tết mẫu</h5>
                                <div class="product-card-price">500.000 đ</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
    <script>
        const maxQuantity = /*[[${sanPham?.soLuong}]]*/ 999;
        const productId = /*[[${sanPham?.maSP}]]*/ 0;

        function changeMainImage(thumbnail) {
            document.getElementById('mainImage').src = thumbnail.src;
            document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
            thumbnail.classList.add('active');
        }

        function decreaseQuantity() {
            const input = document.getElementById('quantity');
            if (input.value > 1) {
                input.value = parseInt(input.value) - 1;
            }
        }

        function increaseQuantity() {
            const input = document.getElementById('quantity');
            if (input.value < maxQuantity) {
                input.value = parseInt(input.value) + 1;
            }
        }

        // TODO THÀNH VIÊN 3: Thêm vào giỏ hàng
        function addToCart() {
            const quantity = document.getElementById('quantity').value;

            fetch('/giohang/api/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `maSP=${productId}&soLuong=${quantity}`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Đã thêm sản phẩm vào giỏ hàng!');
                        // Cập nhật badge giỏ hàng
                        updateCartBadge();
                    } else {
                        alert('Lỗi: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra, vui lòng thử lại!');
                });
        }

        // Mua ngay = Thêm giỏ + Chuyển đến checkout
        function buyNow() {
            const quantity = document.getElementById('quantity').value;

            fetch('/giohang/api/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `maSP=${productId}&soLuong=${quantity}`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '/checkout';
                    } else {
                        alert('Lỗi: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra, vui lòng thử lại!');
                });
        }

        function updateCartBadge() {
            fetch('/giohang/api/count')
                .then(response => response.json())
                .then(data => {
                    const badge = document.querySelector('.cart-badge');
                    if (badge && data.count) {
                        badge.textContent = data.count;
                    }
                });
        }
    </script>
</th:block>
</body>
</html>
