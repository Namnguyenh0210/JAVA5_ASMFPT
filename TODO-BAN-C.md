# TODO - B·∫†N C: SECURITY LAYER

## üìã M·ª§C TI√äU
Implement authentication, authorization v√† session management

## üéØ NHI·ªÜM V·ª§ CH√çNH
1. C·∫•u h√¨nh Spring Security
2. T·∫°o login/register functionality
3. Session management
4. Protect routes theo roles

---

## üÖ≤ C√îNG VI·ªÜC C·ª¶A B·∫†N C - B·∫¢O M·∫¨T & ƒêƒÇNG NH·∫¨P

## üéØ NHI·ªÜM V·ª§: C·∫•u h√¨nh Spring Security v√† l√†m ch·ª©c nƒÉng ƒëƒÉng nh·∫≠p

### ‚úÖ DANH S√ÅCH VI·ªÜC C·∫¶N L√ÄM:

#### üìã Tu·∫ßn 1:
- [ ] T√¨m hi·ªÉu Spring Security c∆° b·∫£n
- [ ] C·∫•u h√¨nh SecurityConfig.java
- [ ] T·∫°o trang ƒëƒÉng nh·∫≠p ƒë∆°n gi·∫£n
- [ ] Test ƒëƒÉng nh·∫≠p c∆° b·∫£n

#### üìã Tu·∫ßn 2:
- [ ] L√†m ch·ª©c nƒÉng ƒëƒÉng k√Ω
- [ ] M√£ h√≥a password
- [ ] Ph√¢n quy·ªÅn Admin/User
- [ ] T√≠ch h·ª£p v·ªõi HTML c√≥ s·∫µn

---

## üìÇ FILE 1: `config/SecurityConfig.java`

### ‚úÖ ƒê√É C√ì:
- Khung SecurityConfig v·ªõi @EnableWebSecurity
- Basic filterChain setup
- PasswordEncoder bean

### üìù C·∫¶N L√ÄM:

#### 1. Ho√†n thi·ªán Security Filter Chain:
```java
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
        .authorizeHttpRequests(authz -> authz
            // Public pages - kh√¥ng c·∫ßn login
            .requestMatchers("/", "/home", "/sanpham/**", "/gioithieu", "/kienthuc", "/lienhe").permitAll()
            .requestMatchers("/css/**", "/js/**", "/img/**", "/favicon.ico").permitAll()
            .requestMatchers("/login", "/register", "/api/auth/status").permitAll()
            
            // Protected pages - c·∫ßn login
            .requestMatchers("/giohang/**", "/profile/**", "/checkout/**").authenticated()
            .requestMatchers("/api/cart/**").authenticated()
            
            // Admin only
            .requestMatchers("/admin/**").hasRole("ADMIN")
            
            .anyRequest().authenticated()
        )
        .formLogin(form -> form
            .loginPage("/login")
            .loginProcessingUrl("/perform_login")
            .defaultSuccessUrl("/", true)
            .failureUrl("/login?error=true")
            .usernameParameter("username")
            .passwordParameter("password")
            .permitAll()
        )
        .logout(logout -> logout
            .logoutUrl("/logout")
            .logoutSuccessUrl("/?logout=true")
            .invalidateHttpSession(true)
            .deleteCookies("JSESSIONID")
            .clearAuthentication(true)
            .permitAll()
        )
        .sessionManagement(session -> session
            .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)
            .maximumSessions(1)
            .maxSessionsPreventsLogin(false)
            .sessionRegistry(sessionRegistry())
        )
        .rememberMe(remember -> remember
            .key("projectend-remember-me")
            .tokenValiditySeconds(86400) // 24 hours
            .userDetailsService(userDetailsService())
        )
        // T·∫°m disable CSRF cho development - ENABLE cho production
        .csrf(csrf -> csrf.disable());
        
    return http.build();
}
```

#### 2. Th√™m SessionRegistry bean:
```java
@Bean
public SessionRegistry sessionRegistry() {
    return new SessionRegistryImpl();
}
```

#### 3. C·∫•u h√¨nh UserDetailsService (khi c√≥ User entity):
```java
@Bean
public UserDetailsService userDetailsService() {
    // TODO: Return custom UserDetailsService implementation
    // For now, use in-memory user for testing
    UserDetails admin = User.builder()
        .username("admin")
        .password(passwordEncoder().encode("admin123"))
        .roles("ADMIN")
        .build();
        
    UserDetails user = User.builder()
        .username("user")
        .password(passwordEncoder().encode("user123"))
        .roles("USER")
        .build();
        
    return new InMemoryUserDetailsManager(admin, user);
}
```

---

## üìÇ FILE 2: `controller/AuthController.java`

### ‚úÖ ƒê√É C√ì:
- Khung controller v·ªõi basic mappings
- Method signatures v·ªõi TODO

### üìù C·∫¶N L√ÄM:

#### 1. Ho√†n thi·ªán loginPage():
```java
@GetMapping("/login")
public String loginPage(@RequestParam(value = "error", required = false) String error,
                       @RequestParam(value = "logout", required = false) String logout,
                       @RequestParam(value = "redirect", required = false) String redirect,
                       Model model,
                       HttpServletRequest request) {
    
    // Handle error messages
    if (error != null) {
        model.addAttribute("errorMessage", "T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!");
        model.addAttribute("alertType", "danger");
    }
    
    // Handle logout message
    if (logout != null) {
        model.addAttribute("successMessage", "ƒêƒÉng xu·∫•t th√†nh c√¥ng!");
        model.addAttribute("alertType", "success");
    }
    
    // Handle redirect after login
    if (redirect != null) {
        model.addAttribute("redirectUrl", redirect);
    }
    
    // Check if already logged in
    Authentication auth = SecurityContextHolder.getContext().getAuthentication();
    if (auth != null && auth.isAuthenticated() && !(auth instanceof AnonymousAuthenticationToken)) {
        return "redirect:/";
    }
    
    model.addAttribute("pageTitle", "ƒêƒÉng nh·∫≠p");
    return "login1"; // S·ª≠ d·ª•ng template c√≥ s·∫µn
}
```

#### 2. Implement registerPage():
```java
@GetMapping("/register")
public String registerPage(Model model) {
    model.addAttribute("pageTitle", "ƒêƒÉng k√Ω t√†i kho·∫£n");
    return "register";
}
```

#### 3. Implement handleRegister():
```java
@PostMapping("/register")
public String handleRegister(@RequestParam String username,
                            @RequestParam String email,
                            @RequestParam String password,
                            @RequestParam String confirmPassword,
                            @RequestParam String fullName,
                            RedirectAttributes redirectAttributes,
                            Model model) {
    
    // Validation
    List<String> errors = new ArrayList<>();
    
    if (username == null || username.trim().length() < 3) {
        errors.add("T√™n ƒëƒÉng nh·∫≠p ph·∫£i c√≥ √≠t nh·∫•t 3 k√Ω t·ª±");
    }
    
    if (email == null || !email.contains("@")) {
        errors.add("Email kh√¥ng h·ª£p l·ªá");
    }
    
    if (password == null || password.length() < 6) {
        errors.add("M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±");
    }
    
    if (!password.equals(confirmPassword)) {
        errors.add("M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp");
    }
    
    // TODO: Check username/email already exists
    // if (userService.existsByUsername(username)) {
    //     errors.add("T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i");
    // }
    
    if (!errors.isEmpty()) {
        model.addAttribute("errors", errors);
        model.addAttribute("username", username);
        model.addAttribute("email", email);
        model.addAttribute("fullName", fullName);
        return "register";
    }
    
    try {
        // TODO: Create user with UserService
        // User newUser = userService.createUser(username, email, password, fullName);
        
        redirectAttributes.addFlashAttribute("successMessage", 
            "ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p.");
        redirectAttributes.addFlashAttribute("alertType", "success");
        return "redirect:/login";
        
    } catch (Exception e) {
        model.addAttribute("errorMessage", "C√≥ l·ªói x·∫£y ra khi ƒëƒÉng k√Ω: " + e.getMessage());
        model.addAttribute("alertType", "danger");
        return "register";
    }
}
```

#### 4. Implement getAuthStatus() cho JavaScript:
```java
@GetMapping("/api/auth/status")
@ResponseBody
public Map<String, Object> getAuthStatus(HttpServletRequest request, 
                                        HttpSession session) {
    Map<String, Object> response = new HashMap<>();
    
    Authentication auth = SecurityContextHolder.getContext().getAuthentication();
    boolean isAuthenticated = auth != null && 
                             auth.isAuthenticated() && 
                             !(auth instanceof AnonymousAuthenticationToken);
    
    response.put("isAuthenticated", isAuthenticated);
    
    if (isAuthenticated) {
        response.put("username", auth.getName());
        response.put("roles", auth.getAuthorities().stream()
            .map(GrantedAuthority::getAuthority)
            .collect(Collectors.toList()));
        response.put("sessionId", session.getId());
    }
    
    return response;
}
```

#### 5. Th√™m success handler t√πy ch·ªânh:
```java
@Component
public class CustomAuthenticationSuccessHandler implements AuthenticationSuccessHandler {
    
    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, 
                                      HttpServletResponse response,
                                      Authentication authentication) throws IOException {
        
        // Log successful login
        String username = authentication.getName();
        String sessionId = request.getSession().getId();
        log.info("User {} logged in with session {}", username, sessionId);
        
        // TODO: Merge localStorage cart v·ªõi database cart
        // cartService.mergeCartOnLogin(sessionId, username);
        
        // Redirect based on role
        Set<String> roles = AuthorityUtils.authorityListToSet(authentication.getAuthorities());
        
        if (roles.contains("ROLE_ADMIN")) {
            response.sendRedirect("/admin");
        } else {
            // Check if there was a redirect URL
            String redirectUrl = request.getParameter("redirect");
            if (redirectUrl != null && !redirectUrl.isEmpty()) {
                response.sendRedirect("/" + redirectUrl);
            } else {
                response.sendRedirect("/");
            }
        }
    }
}
```

---

## üìÇ FILE 3: `templates/register.html` (T·∫†O M·ªöI)

### üìù C·∫¶N T·∫†O template register.html:

```html
<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">ƒêƒÉng k√Ω</title>
    <link rel="stylesheet" th:href="@{/css/login1.css}">
</head>
<body>
    <div class="login-container">
        <div class="login-form">
            <h2>ƒêƒÉng k√Ω t√†i kho·∫£n</h2>
            
            <!-- Error Messages -->
            <div th:if="${errors}" class="alert alert-danger">
                <ul>
                    <li th:each="error : ${errors}" th:text="${error}"></li>
                </ul>
            </div>
            
            <!-- Success Message -->
            <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>
            
            <form th:action="@{/register}" method="post">
                <div class="form-group">
                    <label for="username">T√™n ƒëƒÉng nh·∫≠p:</label>
                    <input type="text" id="username" name="username" 
                           th:value="${username}" required minlength="3">
                </div>
                
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" 
                           th:value="${email}" required>
                </div>
                
                <div class="form-group">
                    <label for="fullName">H·ªç t√™n:</label>
                    <input type="text" id="fullName" name="fullName" 
                           th:value="${fullName}" required>
                </div>
                
                <div class="form-group">
                    <label for="password">M·∫≠t kh·∫©u:</label>
                    <input type="password" id="password" name="password" 
                           required minlength="6">
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u:</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" 
                           required minlength="6">
                </div>
                
                <button type="submit" class="btn-primary">ƒêƒÉng k√Ω</button>
            </form>
            
            <div class="form-footer">
                <p>ƒê√£ c√≥ t√†i kho·∫£n? <a th:href="@{/login}">ƒêƒÉng nh·∫≠p ngay</a></p>
            </div>
        </div>
    </div>
</body>
</html>
```

---

## üìÇ FILE 4: C·∫≠p nh·∫≠t `templates/login1.html`

### üìù C·∫¶N S·ª¨A:

#### 1. Th√™m form action ƒë√∫ng:
```html
<form th:action="@{/perform_login}" method="post">
    <!-- existing form fields -->
    <input type="hidden" th:if="${redirectUrl}" name="redirect" th:value="${redirectUrl}">
</form>
```

#### 2. Th√™m error/success messages:
```html
<!-- Th√™m v√†o ƒë·∫ßu form -->
<div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>
<div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
```

#### 3. Th√™m link ƒëƒÉng k√Ω:
```html
<div class="form-footer">
    <p>Ch∆∞a c√≥ t√†i kho·∫£n? <a th:href="@{/register}">ƒêƒÉng k√Ω ngay</a></p>
</div>
```

---

## üß™ TESTING CHECKLIST

### Security Configuration:
- [ ] Public pages accessible without login
- [ ] Protected pages redirect to login
- [ ] Admin pages require ADMIN role
- [ ] Static resources (CSS/JS) accessible

### Authentication:
- [ ] Login v·ªõi valid credentials th√†nh c√¥ng
- [ ] Login v·ªõi invalid credentials fail
- [ ] Logout clear session v√† redirect
- [ ] Remember-me ho·∫°t ƒë·ªông

### Registration:
- [ ] Register form validation ho·∫°t ƒë·ªông
- [ ] Duplicate username/email ƒë∆∞·ª£c detect
- [ ] Password confirmation works
- [ ] Successful registration redirect to login

### Session Management:
- [ ] Session timeout ho·∫°t ƒë·ªông
- [ ] Multiple login sessions handled
- [ ] Session fixation protection
- [ ] Cart data preserved across login

### API Endpoints:
- [ ] /api/auth/status tr·∫£ ƒë√∫ng authentication status
- [ ] Protected API require authentication
- [ ] CSRF protection (khi enable)

---

## üö® L∆ØU √ù QUAN TR·ªåNG

### 1. Security Best Practices:
- **NEVER** store plain text passwords
- Use BCrypt v·ªõi proper salt rounds
- Implement proper session timeout
- Enable CSRF cho production
- Validate all user inputs

### 2. Integration v·ªõi Cart:
```java
// Khi user login, merge localStorage cart v·ªõi database cart
@EventListener
public void handleLoginSuccess(AuthenticationSuccessEvent event) {
    String username = event.getAuthentication().getName();
    // TODO: Merge cart data
}
```

### 3. Password Policy:
- Minimum 6 characters
- Consider requiring special characters
- Implement password strength meter
- Password reset functionality (future)

### 4. Session Security:
- HttpOnly cookies
- Secure cookies cho HTTPS
- Session timeout reasonable
- Concurrent session control

---

## üîß DEBUG & TESTING

### Test Authentication:
```bash
# Test login
curl -X POST http://localhost:8080/perform_login \
  -d "username=admin&password=admin123" \
  -c cookies.txt

# Test protected endpoint
curl -X GET http://localhost:8080/giohang \
  -b cookies.txt
```

### Monitor Security Events:
```properties
# Add to application.properties
logging.level.org.springframework.security=DEBUG
```

---

## ‚úÖ DEFINITION OF DONE

- [ ] SecurityConfig ho√†n ch·ªânh v√† test
- [ ] Login/Register forms ho·∫°t ƒë·ªông
- [ ] Session management ƒë√∫ng
- [ ] Protected routes work
- [ ] Authentication API endpoints
- [ ] Error handling adequate  
- [ ] Integration v·ªõi existing templates
- [ ] Security testing pass
- [ ] Documentation complete

**Estimated Time**: 1-2 tu·∫ßn

**Dependencies**: C√≥ th·ªÉ l√†m song song v·ªõi B·∫°n B
